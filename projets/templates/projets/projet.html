{% extends "projets/projetbase.html" %}
{% load static %}

{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/projet.css' %}" />
{% endblock %}

{% block title %}
    Journal - {{ projet.titre }}
{% endblock %}

{% block nav-afficher_projet %}current{% endblock %}

{% block header %}
<div class="project-info">
  <input type="hidden" id="slug" value={{ projet.slug }}/>
  {% csrf_token %}
</div>
{% endblock %}

{% block content %}
<section class="today-entry">
  <article>
    <div class="header">
      <h1 class="header__title">Journal - {{ projet.titre }}</h1>
      <div class="header__subtitle">{{ projet.description }}</div>
    </div>
    
    <div class="journal-entry">
      <div class="header">
        <h2 class="header__title">{{ today_entry.date }}</h2>
        <div class="save-info" id="sauvegarde" style="display:none">Sauvegardé</div>          
      </div>
      <div class="content">
        {{ today_entry.journal_entry.non_field_errors }}
        {{ today_entry.journal_entry.texte.errors }}
        {{ today_entry.journal_entry.journal_id.errors }}
        {{ today_entry.journal_entry.texte }}
        {{ today_entry.journal_entry.journal_id }}
      </div>
    </div>  
    
    <div class="task-list">
      <div class="header">
        <h2 class="header__title">Tâches</h2>
        <div class="save-info" style="display:none">Sauvegardé</div>
      </div>
      <div class="content">
        <div class="new-task">
          <img class="add-item-button" id="add_todo" type="image" src="{% static "img/add_button.png" %}" alt="Ajouter" />
          {{ today_entry.new_task.texte.errors }}
          {{ today_entry.new_task.texte }}
        </div>
        {% for task_entry in today_entry.task_list reversed%}
        <div class="entry">
          {{ task_entry.realisee }}
          {{ task_entry.non_field_errors }}
          {{ task_entry.texte.errors }}
          {{ task_entry.todo_id.errors }}
          {{ task_entry.realisee.errors }}
          {{ task_entry.texte }}
          {{ task_entry.todo_id }}
        </div>
      {% endfor %}
      </div>
    </div>
  </article>  
</section>

<section class="older-entry">
  {% for entry in older_entry  reversed %}
  <article>
    <div class="journal-entry">
      <div class="header">
        <h2 class="header__title">{{ entry.date }}</h2>
        <div class="ligne"></div>        
      </div>
      {% if entry.journal_entry %}
      <div class="content">
        {{ entry.journal_entry.non_field_errors }}
        {{ entry.journal_entry.texte.errors }}
        {{ entry.journal_entry.journal_id.errors }}
        {{ entry.journal_entry.texte }}
        {{ entry.journal_entry.journal_id }}
      </div>
      {% endif %}
    </div>  
    
    {% if entry.task_list %}
    <div class="task-list">
      <div class="header">
        <h2 class="header__title">Tâches</h2>
        <div class="save-info" style="display:none">Sauvegardé</div>
        <div class="ligne"></div>
      </div>
      <div class="content">
        {% for task_entry in entry.task_list %}
        <div class="entry">
          {{ task_entry.realisee }}
          {{ task_entry.non_field_errors }}
          {{ task_entry.texte.errors }}
          {{ task_entry.todo_id.errors }}
          {{ task_entry.realisee.errors }}
          {{ task_entry.texte }}
          {{ task_entry.todo_id }}
        </div>
      {% endfor %}
      </div>
    </div>
    {% endif %}
  </article>
  {% endfor %}
</section>
{% endblock %}

{% block script %}
    <script src="{% static 'js/jquery-3.2.1.min.js' %}"></script>
    <script src="{% static 'js/autosize.min.js' %}"></script>
    <script src="{% static 'js/jquery.typewatch.min.js' %}"></script>
    <script src="{% static 'js/afficher_journal.js' %}"></script>
    <script>
        function saveTextarea(){
            var parent_div = $(this).closest(".content")
            var texte = parent_div.find(".journal_entree_texte").val();
            var id = parent_div.find(".journal_entree_id").attr("value");

            $.ajaxSetup({headers: {'X-CSRFToken': $("[name='csrfmiddlewaretoken']").val()}});
            $.ajax({
                url: '/journal/projets/' + $('#slug').val() + 'maj-journal',
                data: {
                    'id': id,
                    'texte': texte,
                },
                dataType: 'json',
                method: 'POST',
                success: function(data){
                    $('.error').remove();
                    if(data.success){
                        if(data.nouveau_journal){
                            $(".today-entry").find(".journal_entree_id").attr('value',data.id);
                        }
                        $('.today-entry .journal-entry .save-info').fadeIn('slow', function(){$('.today-entry .journal-entry .save-info').fadeOut('slow');});
                    }
                    else{
                        $('#id_form-' + form_id + '-id').parent().prepend("<p id='id_form-" + form_id +
                            "-error' class='error'>" + data.form_errors + "</p>");
                    }
                },
                error: function (jqXHR, exception) {
                    var data = jQuery.parseJSON(jqXHR.responseText);
                    $('.error').remove();
                    $('nav').append("<p class='error'>" + 
                        "<span style='color:red'>Erreur " + jqXHR.status + " : " + data.message + "</span>" + 
                        "<br/>" +
                        "<span style='color:red'>" + data.explanation + "</span>" + 
                        "</p>"
                    );        
                }
            });
        }

        $(".journal_typewatch").typeWatch( {
            callback: saveTextarea,
            wait: 500,
            highlight: false,
            allowSubmit: false,
            captureLength: 1,
        });
    
        function maj_todo(){
            var parent_div = $(this).parent();
            var realisee = parent_div.find(".todo_entree_checkbox").prop('checked');
            var texte = parent_div.find(".todo_entree_texte").val();
            var id = parent_div.find(".todo_entree_id").attr("value");
            if(texte != ''){
                $.ajaxSetup({headers: {'X-CSRFToken': $("[name='csrfmiddlewaretoken']").val()}});
                $.ajax({
                    url: '/journal/projets/' + $('#slug').val() + 'maj-todo',
                    data: {
                        'todo_id': id,
                        'texte': texte,
                        'realisee': realisee,
                    },
                    dataType: 'json',
                    method: 'POST',
                    success: function(data){
                        $('.error').remove();
                        if(data.success){
                            if(data.nouvelle_tache){
                                //On retire le texte du formulaire initial
                                $(".today-entry .task-list .new-task .todo_entree_texte").val('');
                                //On cherche la celule d'ajout d'une tache
                                var parent_div = $('.today-entry .task-list .new-task');
                                //On ajoute des <div> au formulaire retourné pour pouvoir naviguer dedans avec jquery
                                out_form_str = '<div>' + data.out_form + '</div>'
                                //On ajoute correctement le formulaire de retour en dessous de l'ajout de tache
                                var new_checkbox = $(".todo_entree_checkbox",out_form_str).clone().wrap('<div>').parent().html()
                                var new_textearea = $(".todo_entree_texte",out_form_str).clone().wrap('<div>').parent().html()
                                var new_id = $(".todo_entree_id",out_form_str).clone().wrap('<div>').parent().html()
                                parent_div.after(
                                    "<div class='entry'>" +
                                    new_checkbox + 
                                    new_textearea +
                                    new_id +
                                    "</div>"
                                );
                                var jqry_textearea = $('.todo_entree_id[value = ' + data.id +']').closest("div").find(".todo_entree_texte");
                                autosize(jqry_textearea);
                                $(jqry_textearea).typeWatch( {
                                    callback: maj_todo,
                                    wait: 500,
                                    highlight: false,
                                    allowSubmit: false,
                                    captureLength: 1,
                                });
                            }
                            else{
                                //On recherche le div de sauvegarde à faire clignoter
                                save_todo = $(".todo_entree_id[value = " + data.id + "]").closest(".task-list").find(".save-info");
                                save_todo.fadeIn('slow', function(){
                                    save_todo = $(".todo_entree_id[value = " + data.id + "]").closest(".task-list").find(".save-info");
                                    save_todo.fadeOut('slow');
                                });
                            }
                        }
                        else{
                            error_todo = $(".todo_entree_id[value = " + data.id + "]").closest("table").parent();
                            error_todo.prepend("<p id='maj_todo-error' class='error'>" + data.form_errors + "</p>");
                        }
                    },
                    error: function (jqXHR, exception) {
                        var data = jQuery.parseJSON(jqXHR.responseText);
                        $('.error').remove();
                        //Ajout de l'erreur dans le bandeau de naviguation
                        $('nav').append("<span class='error'>" +
                            "<span style='color:red'>Erreur " + jqXHR.status + " : " + data.message + "</span>" +
                            "<br/>" +
                            "<span style='color:red'>" + data.explanation + "</span>" + 
                            "</span>"
                        );
                    }
                });
            }    
        }
        
        $('#add_todo').click( maj_todo );
        
        $(document).on('change','.todo_entree_checkbox', maj_todo); 
        
        $(".entry .todo_entree_texte").typeWatch( {
            callback: maj_todo,
            wait: 500,
            highlight: false,
            allowSubmit: false,
            captureLength: 1,
        });
        
        $(".older-entry .journal-entry:not(:has(.content))").parent("article").css("flex-direction", "column");
    </script>
{% endblock %}

   


